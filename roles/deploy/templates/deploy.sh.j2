#!/bin/bash

export PATH="${HOME}/bin:${PATH}"

declare -A dirs=(
{% for app in apps %}
	["{{ app.dest }}"]="{{ apps_dir }}/{{ app.dest }}"
{% endfor %}
)

declare -A cmds=(
{% for app in apps if app.deploy_cmd is defined %}
	["{{ app.dest }}"]="{{ app.deploy_cmd }}"
{% endfor %}
)

default_cmd="docker compose run --rm --no-deps web npm ci && docker compose down && docker compose up -d"
logfile="${HOME}/deploy/deploy.log"
timestamp=$(date)

notifications=()

for name in "${!dirs[@]}"; do
	dir="${dirs[${name}]}"
	cmd="${cmds[${name}]:-${default_cmd}}"

	cd "${dir}" || continue

	branch=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's|refs/remotes/origin/||')
	branch="${branch:-master}"

	if [ -f "${dir}/.deploy-lock" ]; then
		commit_hash=$(git rev-parse --short HEAD)
		commit_msg=$(git log -1 --pretty=%s)

		notifications+=("ðŸ”’ ${name}: ${commit_msg}")
		echo "${timestamp}: skipped ${name} @ ${commit_hash} (locked)" >> "${logfile}"
		continue
	fi

	git fetch origin "${branch}"

	local=$(git rev-parse HEAD)
	remote=$(git rev-parse origin/"${branch}")

	if [ "${local}" != "${remote}" ]; then
		git reset --hard origin/"${branch}"
		eval "${cmd}"

		commit_hash=$(git rev-parse --short HEAD)
		commit_msg=$(git log -1 --pretty=%s)

		notifications+=("ðŸš€ ${name}: ${commit_msg}")
		echo "${timestamp}: deployed ${name} @ ${commit_hash}" >> "${logfile}"
	fi
done

if [ {% raw %}${#notifications[@]}{% endraw %} -gt 0 ]; then
	printf -v ntfy_msg "%s\n\n" "${notifications[@]}"
	curl -s -d "${ntfy_msg}" ntfy.sh/coinflipper > /dev/null
fi

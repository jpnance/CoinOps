---
- name: Sync SSL certificates from current production to a temporary location
  shell: rsync -a coinflipper.org:/etc/letsencrypt/ /tmp/letsencrypt

- name: Copy SSL certificates to final location
  shell: rsync -a /tmp/letsencrypt/ /etc/letsencrypt/
  become: true

- name: Install certbot for auto-renewal
  apt:
    name:
      - certbot
      - python3-certbot-nginx
    state: present
  become: true

- name: Ensure certbot auto-renewal service is running
  service:
    name: certbot.timer
    state: started
    enabled: true
  become: true

- name: Make certs readable by admin user for future migrations
  shell: |
    setfacl -R -m u:{{ admin_user }}:rX /etc/letsencrypt
    setfacl -R -d -m u:{{ admin_user }}:rX /etc/letsencrypt
  become: true

---
- name: Create apps directory
  file:
    path: "{{ apps_dir }}"
    state: directory
    mode: "0755"

- name: Set up Node apps
  include_tasks: setup-app.yml
  loop: "{{ apps | selectattr('type', 'equalto', 'node') | list }}"
  loop_control:
    loop_var: app

- name: Set up static sites
  include_tasks: setup-static.yml
  loop: "{{ apps | selectattr('type', 'equalto', 'static') | list }}"
  loop_control:
    loop_var: app

- name: Create directories for upload sites
  file:
    path: "{{ apps_dir }}/{{ app.slug }}"
    state: directory
  loop: "{{ apps | selectattr('type', 'equalto', 'upload') | list }}"
  loop_control:
    loop_var: app

- name: Start scuttlebot container
  shell: |
    docker inspect scuttlebot > /dev/null 2>&1 || \
    docker run -d --name scuttlebot --restart unless-stopped \
      -v {{ apps_dir }}/pso:/app -w /app \
      node:22-alpine node tools/bots/scuttlebot.js
